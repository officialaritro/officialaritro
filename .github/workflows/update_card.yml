# .github/workflows/update_card.yml
name: Update Neofetch Card

on:
  schedule:
    # Run at 00:00 UTC daily (adjust timezone as needed)
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      force_refresh:
        description: "Force refresh cache"
        required: false
        default: false # Changed from 'false' to false
        type: boolean
  push:
    paths:
      - "scripts/update_card.js"
      - "aritro-neofetch.svg"
      - ".github/workflows/update_card.yml"

env:
  NODE_VERSION: "20"
  CACHE_KEY_PREFIX: "neofetch-cache-v2"

jobs:
  update-card:
    name: Update Neofetch Card
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: write
      actions: read

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: ðŸ“Š Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "**/package*.json"

      - name: ðŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
            ${{ runner.os }}-node-

      - name: ðŸ’¾ Cache GitHub data
        uses: actions/cache@v4
        with:
          path: cache/
          key: ${{ env.CACHE_KEY_PREFIX }}-${{ github.repository_owner }}-${{ github.run_number }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-${{ github.repository_owner }}-
            ${{ env.CACHE_KEY_PREFIX }}-

      - name: ðŸ”§ Install dependencies
        run: |
          # Create package.json if it doesn't exist
          if [ ! -f "package.json" ]; then
            npm init -y >/dev/null 2>&1
          fi

          # Install required dependencies with specific versions for stability
          npm install --save \
            @octokit/rest@^20.0.0 \
            @octokit/graphql@^7.0.0 \
            jsdom@^23.0.0

          echo "âœ… Dependencies installed successfully"

      - name: ðŸ” Pre-flight checks
        run: |
          echo "ðŸ” Running pre-flight checks..."

          # Check Node.js version
          echo "Node.js version: $(node --version)"
          echo "NPM version: $(npm --version)"

          # Check required files
          if [ ! -f "scripts/update_card.js" ]; then
            echo "âŒ update_card.js not found!"
            exit 1
          fi

          if [ ! -f "aritro-neofetch.svg" ]; then
            echo "âŒ aritro-neofetch.svg not found!"
            exit 1
          fi

          # Check environment variables
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "âŒ GITHUB_TOKEN not found!"
            exit 1
          fi

          if [ -z "${{ secrets.DOB_ISO }}" ]; then
            echo "âš ï¸ DOB_ISO not found, using fallback"
          fi

          # Create cache directory if it doesn't exist
          mkdir -p cache

          echo "âœ… Pre-flight checks passed"

      - name: ðŸš€ Update SVG card
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOB_ISO: ${{ secrets.DOB_ISO }}
          FORCE_REFRESH: ${{ github.event.inputs.force_refresh }}
        run: |
          echo "ðŸš€ Starting card update process..."

          # Set force refresh flag if requested
          if [ "$FORCE_REFRESH" = "true" ]; then
            echo "ðŸ”„ Force refresh requested, clearing cache..."
            rm -rf cache/*.json
          fi

          # Run the update script with error handling
          set -e
          node scripts/update_card.js

          echo "âœ… Card update completed successfully"

      - name: ðŸ“‹ Post-update verification
        id: verify # Added ID to reference this step
        run: |
          echo "ðŸ“‹ Verifying update results..."

          # Check if SVG was modified
          if git diff --quiet aritro-neofetch.svg; then
            echo "svg_changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "svg_changed=true" >> "$GITHUB_OUTPUT"
            
            # Show diff stats
            echo "ðŸ“Š Changes made:"
            git diff --stat aritro-neofetch.svg
          fi

          # Check cache status
          if [ -d "cache" ] && [ "$(ls -A cache)" ]; then
            cache_files=$(ls cache | wc -l)
            echo "ðŸ’¾ Cache contains $cache_files files"
            ls -la cache/
          else
            echo "ðŸ“­ No cache files found"
          fi

      - name: ðŸŽ¯ Commit and push changes
        if: steps.verify.outputs.svg_changed == 'true' # Updated condition
        run: |
          echo "ðŸŽ¯ Committing changes..."

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add and commit changes
          git add aritro-neofetch.svg

          # Create commit with timestamp and stats
          commit_msg="chore: update neofetch card - $(date -u +"%Y-%m-%d %H:%M UTC")"

          # Add some stats to commit message if possible
          if command -v wc >/dev/null; then
            lines_changed=$(git diff --cached --numstat aritro-neofetch.svg | cut -f1,2 | tr '\t' '+')
            if [ -n "$lines_changed" ]; then
              commit_msg="$commit_msg ($lines_changed lines)"
            fi
          fi

          git commit -m "$commit_msg [skip ci]"

          # Push with retry logic
          max_attempts=3
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "ðŸ“¤ Push attempt $attempt of $max_attempts..."
            
            if git push origin HEAD; then
              echo "âœ… Successfully pushed changes"
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ Failed to push after $max_attempts attempts"
                exit 1
              fi
              
              echo "âš ï¸ Push failed, retrying in 5 seconds..."
              sleep 5
              attempt=$((attempt + 1))
            fi
          done

      - name: ðŸ“Š Generate summary
        if: always()
        run: |
          echo "# ðŸŽ¨ Neofetch Card Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add status
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **Status**: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "ðŸ•’ **Run Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

          # Add change status
          if [ "${svg_changed:-false}" = "true" ]; then
            echo "ðŸ“ **Changes**: SVG updated and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ **Changes**: No changes needed" >> $GITHUB_STEP_SUMMARY
          fi

          # Add cache info
          if [ -d "cache" ] && [ "$(ls -A cache 2>/dev/null)" ]; then
            cache_size=$(du -sh cache 2>/dev/null | cut -f1 || echo "Unknown")
            echo "ðŸ’¾ **Cache Size**: $cache_size" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated update by GitHub Actions* ðŸ¤–" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§¹ Cleanup on failure
        if: failure()
        run: |
          echo "ðŸ§¹ Cleaning up after failure..."

          # Restore SVG backup if it exists
          if [ -f "aritro-neofetch.svg.bak" ]; then
            echo "ðŸ”„ Restoring SVG backup..."
            mv aritro-neofetch.svg.bak aritro-neofetch.svg
          fi

          # Reset any staged changes
          git reset HEAD --hard 2>/dev/null || true

          echo "âœ… Cleanup completed"
